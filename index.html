<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Guess - Music Challenge</title>
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(29, 185, 84, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        .timer-bar {
            transition: width 0.1s linear;
        }
        
        .song-option {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .song-option:hover {
            transform: translateX(10px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .correct {
            background: rgba(29, 185, 84, 0.3) !important;
            border-color: #1DB954 !important;
        }
        
        .incorrect {
            background: rgba(239, 68, 68, 0.3) !important;
            border-color: #ef4444 !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .wave {
            animation: wave 1s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% {
                transform: scaleY(0.5);
            }
            50% {
                transform: scaleY(1);
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Login Screen -->
        <div id="loginScreen" class="text-center">
            <div class="glass rounded-3xl p-8 md:p-12 fade-in">
                <h1 class="text-5xl md:text-7xl font-bold text-white mb-4">üéµ Spotify Guess</h1>
                <p class="text-xl md:text-2xl text-white/90 mb-8">Can you guess the song in seconds?</p>
                
                <div class="grid grid-cols-4 gap-2 mb-8 max-w-xs mx-auto">
                    <div class="h-12 bg-green-400 rounded wave" style="animation-delay: 0s"></div>
                    <div class="h-12 bg-green-400 rounded wave" style="animation-delay: 0.1s"></div>
                    <div class="h-12 bg-green-400 rounded wave" style="animation-delay: 0.2s"></div>
                    <div class="h-12 bg-green-400 rounded wave" style="animation-delay: 0.3s"></div>
                </div>
                
                <div class="space-y-4 mb-8">
                    <div class="text-left text-white/80 max-w-md mx-auto space-y-2">
                        <p class="flex items-center gap-2">
                            <span class="text-2xl">‚è±Ô∏è</span>
                            <span>Guess songs in 1, 3, 5, or 10 seconds</span>
                        </p>
                        <p class="flex items-center gap-2">
                            <span class="text-2xl">üéØ</span>
                            <span>Earn points based on speed</span>
                        </p>
                        <p class="flex items-center gap-2">
                            <span class="text-2xl">üîí</span>
                            <span>All data stored locally - no cloud</span>
                        </p>
                    </div>
                </div>
                
                <button id="loginBtn" class="btn-primary text-white font-bold py-4 px-8 rounded-full text-xl">
                    Connect with Spotify
                </button>
                
                <p class="text-white/60 text-sm mt-6">
                    Your Spotify data stays on your device only
                </p>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Header -->
            <div class="glass rounded-2xl p-4 mb-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" class="w-12 h-12 rounded-full border-2 border-white" src="" alt="User">
                    <div>
                        <p class="text-white font-semibold" id="userName">Player</p>
                        <p class="text-white/70 text-sm">Score: <span id="score">0</span></p>
                    </div>
                </div>
                <button id="logoutBtn" class="text-white/80 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>

            <!-- Game Area -->
            <div class="glass rounded-3xl p-6 md:p-8 fade-in">
                <!-- Start Screen -->
                <div id="startScreen" class="text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-6">Ready to Play?</h2>
                    <p class="text-white/80 mb-8">We'll play snippets from your top tracks and liked songs</p>
                    <button id="startGameBtn" class="btn-primary text-white font-bold py-4 px-12 rounded-full text-xl">
                        Start Game üéÆ
                    </button>
                </div>

                <!-- Playing Screen -->
                <div id="playingScreen" class="hidden">
                    <!-- Round Info -->
                    <div class="text-center mb-6">
                        <p class="text-white/70 text-sm mb-2">Round <span id="currentRound">1</span> of 5</p>
                        <div class="flex justify-center gap-2 mb-4">
                            <div class="h-2 w-12 rounded-full bg-white/20" id="round1"></div>
                            <div class="h-2 w-12 rounded-full bg-white/20" id="round2"></div>
                            <div class="h-2 w-12 rounded-full bg-white/20" id="round3"></div>
                            <div class="h-2 w-12 rounded-full bg-white/20" id="round4"></div>
                            <div class="h-2 w-12 rounded-full bg-white/20" id="round5"></div>
                        </div>
                        <h3 class="text-2xl md:text-3xl font-bold text-white mb-2" id="attemptTitle">Listen carefully...</h3>
                        <p class="text-white/80" id="attemptSubtitle">1 second clip - 400 points</p>
                    </div>

                    <!-- Audio Visualizer -->
                    <div class="bg-white/10 rounded-2xl p-8 mb-6 text-center">
                        <div id="playButton" class="inline-flex items-center justify-center w-20 h-20 bg-green-500 rounded-full cursor-pointer hover:bg-green-400 transition mb-4">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </div>
                        <div id="pauseButton" class="hidden inline-flex items-center justify-center w-20 h-20 bg-green-500 rounded-full cursor-pointer hover:bg-green-400 transition mb-4">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                            </svg>
                        </div>
                        <p class="text-white/70 text-sm" id="playStatus">Click to play</p>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-white/20 rounded-full h-2 mt-4">
                            <div id="progressBar" class="timer-bar bg-green-400 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Song Options -->
                    <div id="songOptions" class="space-y-3">
                        <!-- Options will be dynamically added here -->
                    </div>

                    <!-- Next Button (hidden initially) -->
                    <div class="text-center mt-6">
                        <button id="nextBtn" class="hidden btn-secondary text-white font-bold py-3 px-8 rounded-full">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Results Screen -->
                <div id="resultsScreen" class="hidden text-center">
                    <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Game Over! üéâ</h2>
                    <p class="text-6xl font-bold text-green-400 mb-8" id="finalScore">0</p>
                    
                    <div class="bg-white/10 rounded-2xl p-6 mb-8 max-w-md mx-auto">
                        <h3 class="text-xl font-semibold text-white mb-4">Your Results</h3>
                        <div class="space-y-2 text-white/80" id="resultBreakdown">
                            <!-- Results will be added here -->
                        </div>
                    </div>
                    
                    <div class="flex gap-4 justify-center flex-wrap">
                        <button id="playAgainBtn" class="btn-primary text-white font-bold py-3 px-8 rounded-full">
                            Play Again üîÑ
                        </button>
                        <button id="newSongsBtn" class="btn-secondary text-white font-bold py-3 px-8 rounded-full">
                            New Songs üéµ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="hidden">
            <div class="glass rounded-3xl p-12 text-center">
                <div class="grid grid-cols-4 gap-2 mb-6 max-w-xs mx-auto">
                    <div class="h-16 bg-green-400 rounded wave" style="animation-delay: 0s"></div>
                    <div class="h-16 bg-green-400 rounded wave" style="animation-delay: 0.1s"></div>
                    <div class="h-16 bg-green-400 rounded wave" style="animation-delay: 0.2s"></div>
                    <div class="h-16 bg-green-400 rounded wave" style="animation-delay: 0.3s"></div>
                </div>
                <p class="text-white text-xl" id="loadingText">Loading your music...</p>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="auto"></audio>

    <script>
        // Spotify API Configuration
        const CLIENT_ID = '789244d326c143f9b6a28ac5c140d22f'; // Users need to replace this
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-read-private user-read-email user-top-read user-library-read';
        
        // Game State
        let accessToken = null;
        let userProfile = null;
        let currentSongs = [];
        let currentRound = 0;
        let currentAttempt = 0;
        let score = 0;
        let roundResults = [];
        let audioPlayer = document.getElementById('audioPlayer');
        let currentCorrectSong = null;
        
        const attempts = [
            { duration: 1, points: 400, title: '1 Second Challenge', subtitle: 'Lightning round - 400 points!' },
            { duration: 3, points: 300, title: '3 Second Challenge', subtitle: 'Quick thinking - 300 points' },
            { duration: 5, points: 200, title: '5 Second Challenge', subtitle: 'Getting easier - 200 points' },
            { duration: 10, points: 100, title: '10 Second Challenge', subtitle: 'Final chance - 100 points' }
        ];

        // Initialize
        window.addEventListener('load', () => {
            checkAuth();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('startGameBtn').addEventListener('click', startNewGame);
            document.getElementById('playButton').addEventListener('click', playAudio);
            document.getElementById('pauseButton').addEventListener('click', pauseAudio);
            document.getElementById('nextBtn').addEventListener('click', nextAttempt);
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                currentRound = 0;
                score = 0;
                roundResults = [];
                startNewGame();
            });
            document.getElementById('newSongsBtn').addEventListener('click', () => {
                currentRound = 0;
                score = 0;
                roundResults = [];
                currentSongs = [];
                startNewGame();
            });
        }

        function checkAuth() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            if (params.get('access_token')) {
                accessToken = params.get('access_token');
                localStorage.setItem('spotify_access_token', accessToken);
                window.location.hash = '';
                loadUserProfile();
            } else {
                accessToken = localStorage.getItem('spotify_access_token');
                if (accessToken) {
                    loadUserProfile();
                }
            }
        }

        function login() {
            if (CLIENT_ID === '789244d326c143f9b6a28ac5c140d22f') {
                alert('Please set up your Spotify Client ID first!\n\n1. Go to https://developer.spotify.com/dashboard\n2. Create an app\n3. Add ' + REDIRECT_URI + ' to Redirect URIs\n4. Replace YOUR_SPOTIFY_CLIENT_ID in the code with your Client ID');
                return;
            }
            
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&response_type=token&show_dialog=true`;
            window.location.href = authUrl;
        }

        function logout() {
            localStorage.removeItem('spotify_access_token');
            accessToken = null;
            userProfile = null;
            showScreen('loginScreen');
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch profile');
                }
                
                userProfile = await response.json();
                document.getElementById('userName').textContent = userProfile.display_name;
                document.getElementById('userAvatar').src = userProfile.images[0]?.url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>';
                
                showScreen('gameScreen');
                document.getElementById('startScreen').classList.remove('hidden');
                document.getElementById('playingScreen').classList.add('hidden');
                document.getElementById('resultsScreen').classList.add('hidden');
            } catch (error) {
                console.error('Error loading profile:', error);
                logout();
            }
        }

        async function startNewGame() {
            showScreen('loadingScreen');
            
            try {
                if (currentSongs.length === 0) {
                    await loadSongs();
                }
                
                showScreen('gameScreen');
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('playingScreen').classList.remove('hidden');
                document.getElementById('resultsScreen').classList.add('hidden');
                
                document.getElementById('score').textContent = score;
                updateRoundIndicator();
                startRound();
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Failed to load songs. Please try again.');
                showScreen('gameScreen');
            }
        }

        async function loadSongs() {
            const songs = new Set();
            
            // Get top tracks
            try {
                const topResponse = await fetch('https://api.spotify.com/v1/me/top/tracks?limit=50&time_range=medium_term', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (topResponse.ok) {
                    const topData = await topResponse.json();
                    topData.items.forEach(track => {
                        if (track.preview_url) {
                            songs.add(JSON.stringify({
                                id: track.id,
                                name: track.name,
                                artist: track.artists[0].name,
                                preview_url: track.preview_url,
                                image: track.album.images[0]?.url
                            }));
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching top tracks:', error);
            }

            // Get liked songs
            try {
                const likedResponse = await fetch('https://api.spotify.com/v1/me/tracks?limit=50', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (likedResponse.ok) {
                    const likedData = await likedResponse.json();
                    likedData.items.forEach(item => {
                        if (item.track.preview_url) {
                            songs.add(JSON.stringify({
                                id: item.track.id,
                                name: item.track.name,
                                artist: item.track.artists[0].name,
                                preview_url: item.track.preview_url,
                                image: item.track.album.images[0]?.url
                            }));
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching liked songs:', error);
            }

            const songsArray = Array.from(songs).map(s => JSON.parse(s));
            
            if (songsArray.length < 20) {
                throw new Error('Not enough songs with previews available');
            }

            // Shuffle and select 5 songs for the game
            currentSongs = shuffleArray(songsArray).slice(0, 5);
        }

        function startRound() {
            if (currentRound >= 5) {
                showResults();
                return;
            }
            
            currentAttempt = 0;
            currentCorrectSong = currentSongs[currentRound];
            
            updateRoundIndicator();
            setupAttempt();
        }

        function setupAttempt() {
            const attempt = attempts[currentAttempt];
            
            document.getElementById('currentRound').textContent = currentRound + 1;
            document.getElementById('attemptTitle').textContent = attempt.title;
            document.getElementById('attemptSubtitle').textContent = attempt.subtitle;
            
            // Setup audio
            audioPlayer.src = currentCorrectSong.preview_url;
            audioPlayer.currentTime = 0;
            
            // Reset UI
            document.getElementById('playButton').classList.remove('hidden');
            document.getElementById('pauseButton').classList.add('hidden');
            document.getElementById('playStatus').textContent = 'Click to play';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('nextBtn').classList.add('hidden');
            
            // Generate options
            generateOptions();
        }

        function generateOptions() {
            const optionsDiv = document.getElementById('songOptions');
            optionsDiv.innerHTML = '';
            
            // Get 3 random wrong answers
            const wrongSongs = currentSongs.filter(s => s.id !== currentCorrectSong.id);
            const wrongOptions = shuffleArray(wrongSongs).slice(0, 3);
            
            // Combine with correct answer and shuffle
            const allOptions = shuffleArray([currentCorrectSong, ...wrongOptions]);
            
            allOptions.forEach(song => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'song-option glass rounded-xl p-4 flex items-center gap-4 border-2 border-transparent';
                optionDiv.innerHTML = `
                    <img src="${song.image || ''}" alt="${song.name}" class="w-16 h-16 rounded-lg">
                    <div class="flex-1 text-left">
                        <p class="text-white font-semibold">${song.name}</p>
                        <p class="text-white/70 text-sm">${song.artist}</p>
                    </div>
                `;
                
                optionDiv.addEventListener('click', () => selectOption(song, optionDiv));
                optionsDiv.appendChild(optionDiv);
            });
        }

        function selectOption(song, element) {
            // Prevent multiple selections
            const options = document.querySelectorAll('.song-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            pauseAudio();
            
            const isCorrect = song.id === currentCorrectSong.id;
            
            if (isCorrect) {
                element.classList.add('correct');
                const points = attempts[currentAttempt].points;
                score += points;
                document.getElementById('score').textContent = score;
                
                roundResults.push({
                    round: currentRound + 1,
                    attempt: currentAttempt + 1,
                    points: points,
                    song: currentCorrectSong
                });
                
                setTimeout(() => {
                    currentRound++;
                    startRound();
                }, 1500);
            } else {
                element.classList.add('incorrect');
                
                // Highlight correct answer
                options.forEach(opt => {
                    const songName = opt.querySelector('p').textContent;
                    if (songName === currentCorrectSong.name) {
                        opt.classList.add('correct');
                    }
                });
                
                // Move to next attempt or next round
                if (currentAttempt < 3) {
                    document.getElementById('nextBtn').classList.remove('hidden');
                } else {
                    roundResults.push({
                        round: currentRound + 1,
                        attempt: 'Failed',
                        points: 0,
                        song: currentCorrectSong
                    });
                    
                    setTimeout(() => {
                        currentRound++;
                        startRound();
                    }, 2500);
                }
            }
        }

        function nextAttempt() {
            currentAttempt++;
            
            if (currentAttempt >= 4) {
                currentRound++;
                startRound();
            } else {
                // Re-enable options
                const options = document.querySelectorAll('.song-option');
                options.forEach(opt => {
                    opt.style.pointerEvents = 'auto';
                    opt.classList.remove('incorrect', 'correct');
                });
                
                setupAttempt();
            }
        }

        function playAudio() {
            const attempt = attempts[currentAttempt];
            const duration = attempt.duration;
            
            audioPlayer.currentTime = 15; // Start from middle of preview
            audioPlayer.play();
            
            document.getElementById('playButton').classList.add('hidden');
            document.getElementById('pauseButton').classList.remove('hidden');
            document.getElementById('playStatus').textContent = `Playing ${duration}s...`;
            
            let startTime = Date.now();
            const interval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                const progress = (elapsed / duration) * 100;
                
                document.getElementById('progressBar').style.width = `${Math.min(progress, 100)}%`;
                
                if (elapsed >= duration) {
                    clearInterval(interval);
                    pauseAudio();
                    document.getElementById('playStatus').textContent = 'Finished - Make your guess!';
                }
            }, 50);
            
            setTimeout(() => {
                audioPlayer.pause();
            }, duration * 1000);
        }

        function pauseAudio() {
            audioPlayer.pause();
            document.getElementById('playButton').classList.remove('hidden');
            document.getElementById('pauseButton').classList.add('hidden');
        }

        function updateRoundIndicator() {
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`round${i}`);
                if (i <= currentRound) {
                    indicator.classList.add('bg-green-400');
                    indicator.classList.remove('bg-white/20');
                } else if (i === currentRound + 1) {
                    indicator.classList.add('bg-white/50');
                    indicator.classList.remove('bg-white/20', 'bg-green-400');
                } else {
                    indicator.classList.add('bg-white/20');
                    indicator.classList.remove('bg-green-400', 'bg-white/50');
                }
            }
        }

        function showResults() {
            document.getElementById('playingScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = score + ' points';
            
            const breakdown = document.getElementById('resultBreakdown');
            breakdown.innerHTML = '';
            
            roundResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex justify-between items-center py-2 border-b border-white/10';
                resultDiv.innerHTML = `
                    <div class="text-left">
                        <p class="font-semibold">${result.song.name}</p>
                        <p class="text-sm text-white/60">${result.song.artist}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${result.points > 0 ? 'text-green-400' : 'text-red-400'}">${result.points > 0 ? '+' + result.points : '0'}</p>
                        <p class="text-xs text-white/60">${result.attempt === 'Failed' ? 'Failed' : 'Attempt ' + result.attempt}</p>
                    </div>
                `;
                breakdown.appendChild(resultDiv);
            });
        }

        function showScreen(screenId) {
            const screens = ['loginScreen', 'gameScreen', 'loadingScreen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>